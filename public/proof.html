<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Proof Page</title>
  <link rel="stylesheet" href="css/styles.css">
  <style>
    .gallery {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .gallery img {
      max-width: 200px;
      border: 2px solid #333;
      cursor: pointer;
      border-radius: 8px;
    }
    #imgModal {
      display: none;
      position: fixed;
      z-index: 9999;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.9);
      justify-content: center;
      align-items: center;
    }
    #imgModal img {
      max-width: 90%;
      max-height: 90%;
      border: 3px solid #fff;
      border-radius: 10px;
    }
    #imgModal span {
      position: absolute;
      top: 20px;
      right: 40px;
      font-size: 40px;
      color: white;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Proof Images</h2>
    <div class="gallery" id="gallery"></div>
  </div>

  <div id="imgModal">
    <span onclick="closeModal()">&times;</span>
    <img id="modalImg">
  </div>

  <script>
    async function loadProof() {
      const res = await fetch("/proof-data");
      const data = await res.json();
      const gallery = document.getElementById("gallery");
      gallery.innerHTML = "";

      // Check if user is admin
      let isAdmin = false;
      try {
        const token = localStorage.getItem("ararena_token");
        if (token) {
          const userRes = await fetch("/api/auth/me", { headers: { "Authorization": `Bearer ${token}` } });
          if (userRes.ok) {
            const user = await userRes.json();
            isAdmin = user.role === "admin";
          }
        }
      } catch (e) {
        console.log("Not logged in or not admin");
      }

      if (data.images && data.images.length > 0) {
        data.images.forEach(img => {
          const container = document.createElement("div");
          container.style.position = "relative";
          container.style.display = "inline-block";
          container.style.margin = "10px";

          const imageElem = document.createElement("img");
          imageElem.src = img;
          imageElem.onclick = () => showModal(img);
          imageElem.style.maxWidth = "200px";
          imageElem.style.border = "2px solid #333";
          imageElem.style.cursor = "pointer";
          imageElem.style.borderRadius = "8px";

          container.appendChild(imageElem);

          if (isAdmin) {
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete";
            deleteBtn.style.position = "absolute";
            deleteBtn.style.top = "5px";
            deleteBtn.style.right = "5px";
            deleteBtn.style.background = "red";
            deleteBtn.style.color = "white";
            deleteBtn.style.border = "none";
            deleteBtn.style.padding = "2px 5px";
            deleteBtn.style.cursor = "pointer";
            deleteBtn.style.borderRadius = "3px";
            deleteBtn.onclick = (e) => {
              e.stopPropagation();
              deleteImage(img);
            };
            container.appendChild(deleteBtn);
          }

          gallery.appendChild(container);
        });
      } else {
        gallery.innerHTML = "<p>No proof uploaded yet.</p>";
      }
    }

    function showModal(src) {
      document.getElementById("modalImg").src = src;
      document.getElementById("imgModal").style.display = "flex";
    }

    function closeModal() {
      document.getElementById("imgModal").style.display = "none";
    }

    async function deleteImage(imgPath) {
      if (!confirm("Are you sure you want to delete this image?")) return;
      try {
        const token = localStorage.getItem("ararena_token");
        const res = await fetch(`/proof-images/${encodeURIComponent(imgPath)}`, {
          method: "DELETE",
          headers: { "Authorization": `Bearer ${token}` }
        });
        if (res.ok) {
          alert("Image deleted successfully");
          loadProof(); // Reload images
        } else {
          alert("Failed to delete image");
        }
      } catch (e) {
        alert("Error deleting image");
      }
    }

    loadProof();
  </script>
</body>
</html>
